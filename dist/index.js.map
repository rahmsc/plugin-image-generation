{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { elizaLogger, generateText } from \"@elizaos/core\";\nimport {\n  type Action,\n  type HandlerCallback,\n  type IAgentRuntime,\n  type Memory,\n  type Plugin,\n  type State,\n  ModelClass,\n} from \"@elizaos/core\";\nimport { generateImage } from \"@elizaos/core\";\nimport fs from \"node:fs\";\nimport path from \"node:path\";\nimport { validateImageGenConfig } from \"./environment\";\nimport { fileURLToPath } from \"url\";\nimport { dirname } from \"path\";\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n\nconst IMAGE_SYSTEM_PROMPT = `You are an expert in writing prompts for AI art generation. Keep your prompts concise (25 words or less) and focused on visual elements. Do not include any narrative or dialogue. Example: \"A regal cat wearing a top hat, sipping milk from a crystal glass, elegant lighting, detailed fur texture.\"`;\n\ntype OpenAIImageResponse = {\n  created: number;\n  data: Array<{\n    url?: string; // for dall-e-2 and dall-e-3\n    b64_json?: string; // for dall-e-2\n    revised_prompt?: string; // for dall-e-3\n  }>;\n};\n\nexport function saveBase64Image(base64Data: string, filename: string): string {\n  // Create images directory if it doesn't exist\n  const imageDir = path.join(__dirname, \"images\", \"lora\");\n  elizaLogger.log(\"Saving base64 image to directory:\", imageDir);\n\n  if (!fs.existsSync(imageDir)) {\n    elizaLogger.log(\"Creating directory as it doesn't exist\");\n    fs.mkdirSync(imageDir, { recursive: true });\n  }\n\n  // Remove the data:image/png;base64 prefix if it exists\n  const base64Image = base64Data.replace(/^data:image\\/\\w+;base64,/, \"\");\n\n  // Create a buffer from the base64 string\n  const imageBuffer = Buffer.from(base64Image, \"base64\");\n\n  // Create full file path\n  const filepath = path.join(imageDir, `${filename}.png`);\n\n  // Save the file\n  fs.writeFileSync(filepath, imageBuffer);\n\n  return filepath;\n}\n\nexport async function saveHeuristImage(\n  imageUrl: string,\n  filename: string\n): Promise<string> {\n  const imageDir = path.join(__dirname, \"images\", \"lora\");\n  elizaLogger.log(\"Saving Heurist image to directory:\", imageDir);\n  if (!fs.existsSync(imageDir)) {\n    fs.mkdirSync(imageDir, { recursive: true });\n  }\n\n  // Fetch image from URL\n  const response = await fetch(imageUrl);\n  if (!response.ok) {\n    throw new Error(`Failed to fetch image: ${response.statusText}`);\n  }\n\n  const arrayBuffer = await response.arrayBuffer();\n  const imageBuffer = Buffer.from(arrayBuffer);\n\n  // Create full file path\n  const filepath = path.join(imageDir, `${filename}.png`);\n\n  // Save the file\n  fs.writeFileSync(filepath, imageBuffer);\n\n  return filepath;\n}\n\nelizaLogger.log(\"Loading milk image generation plugin\");\n\nconst milkImageGeneration: Action = {\n  name: \"MILK_IMAGE_GENERATION\",\n  similes: [\n    \"IMAGE_GENERATION\",\n    \"IMAGE_GEN\",\n    \"CREATE_IMAGE\",\n    \"MAKE_PICTURE\",\n    \"GENERATE_IMAGE\",\n    \"GENERATE_A\",\n    \"DRAW\",\n    \"DRAW_A\",\n    \"MAKE_A\",\n  ],\n  description: \"Generate an image to go along with the message.\",\n  suppressInitialMessage: true,\n  validate: async (runtime: IAgentRuntime, message: Memory) => {\n    const openAiApiKey = runtime.getSetting(\"OPENAI_API_KEY\");\n    console.log(\"ðŸ”‘ Testing OpenAI API Key:\", !!openAiApiKey);\n\n    // You can test by setting this in your .env file:\n    // OPENAI_API_KEY=your_api_key_here\n    return !!openAiApiKey;\n  },\n  handler: async (\n    runtime: IAgentRuntime,\n    message: Memory,\n    state: State,\n    options: any,\n    callback: HandlerCallback\n  ) => {\n    console.log(\"ðŸš€ HANDLER: Starting image generation\");\n\n    // Give feedback to user that we're working on it\n    callback({\n      text: \"Starting to generate your image...\",\n    });\n\n    const imagePrompt = await generateText({\n      runtime,\n      context: message.content.text,\n      modelClass: ModelClass.MEDIUM,\n      customSystemPrompt: IMAGE_SYSTEM_PROMPT,\n    });\n\n    console.log(\"ðŸŽ¨ Generated prompt:\", imagePrompt);\n\n    // Update user on progress\n    callback({\n      text: `Creating image with prompt: ${imagePrompt}`,\n    });\n\n    const images = await generateImage(\n      {\n        prompt: imagePrompt,\n        modelId: \"dall-e-3\",\n        width: 1024,\n        height: 1024,\n      },\n      runtime\n    );\n\n    console.log(\"ðŸ–¼ï¸ Image generation result:\", images);\n\n    if (images.success && images.data && images.data.length > 0) {\n      callback({\n        text: \"Here's your generated image\",\n        attachments: [\n          {\n            id: crypto.randomUUID(),\n            url: images.data[0],\n            title: \"Generated image\",\n            source: \"imageGeneration\",\n            description: imagePrompt,\n            text: imagePrompt,\n            contentType: \"image/png\",\n          },\n        ],\n      });\n      return true;\n    }\n\n    callback({\n      text: \"Sorry, image generation failed\",\n    });\n    return false;\n  },\n  examples: [\n    // TODO: We want to generate images in more abstract ways, not just when asked to generate an image\n\n    [\n      {\n        user: \"{{user1}}\",\n        content: { text: \"Generate an image of a cat\" },\n      },\n      {\n        user: \"{{agentName}}\",\n        content: {\n          text: \"Here's an image of a cat\",\n          action: \"GENERATE_IMAGE\",\n        },\n      },\n    ],\n    [\n      {\n        user: \"{{user1}}\",\n        content: { text: \"Generate an image of a dog\" },\n      },\n      {\n        user: \"{{agentName}}\",\n        content: {\n          text: \"Here's an image of a dog\",\n          action: \"GENERATE_IMAGE\",\n        },\n      },\n    ],\n    [\n      {\n        user: \"{{user1}}\",\n        content: { text: \"Create an image of a cat with a hat\" },\n      },\n      {\n        user: \"{{agentName}}\",\n        content: {\n          text: \"Here's an image of a cat with a hat\",\n          action: \"GENERATE_IMAGE\",\n        },\n      },\n    ],\n    [\n      {\n        user: \"{{user1}}\",\n        content: { text: \"Make an image of a dog with a hat\" },\n      },\n      {\n        user: \"{{agentName}}\",\n        content: {\n          text: \"Here's an image of a dog with a hat\",\n          action: \"GENERATE_IMAGE\",\n        },\n      },\n    ],\n    [\n      {\n        user: \"{{user1}}\",\n        content: { text: \"Paint an image of a cat with a hat\" },\n      },\n      {\n        user: \"{{agentName}}\",\n        content: {\n          text: \"Here's an image of a cat with a hat\",\n          action: \"GENERATE_IMAGE\",\n        },\n      },\n    ],\n  ],\n} as Action;\n\nexport const milkImageGenerationPlugin: Plugin = {\n  name: \"milkImageGeneration\",\n  description: \"Generate images\",\n  actions: [milkImageGeneration],\n  evaluators: [],\n  providers: [],\n};\n\nelizaLogger.log(\"Exporting milk image generation plugin\");\nexport default milkImageGenerationPlugin;\n"],"mappings":";AAAA,SAAS,aAAa,oBAAoB;AAC1C;AAAA,EAOE;AAAA,OACK;AACP,SAAS,qBAAqB;AAC9B,OAAO,QAAQ;AACf,OAAO,UAAU;AAEjB,SAAS,qBAAqB;AAC9B,SAAS,eAAe;AAExB,IAAM,aAAa,cAAc,YAAY,GAAG;AAChD,IAAM,YAAY,QAAQ,UAAU;AAEpC,IAAM,sBAAsB;AAWrB,SAAS,gBAAgB,YAAoB,UAA0B;AAE5E,QAAM,WAAW,KAAK,KAAK,WAAW,UAAU,MAAM;AACtD,cAAY,IAAI,qCAAqC,QAAQ;AAE7D,MAAI,CAAC,GAAG,WAAW,QAAQ,GAAG;AAC5B,gBAAY,IAAI,wCAAwC;AACxD,OAAG,UAAU,UAAU,EAAE,WAAW,KAAK,CAAC;AAAA,EAC5C;AAGA,QAAM,cAAc,WAAW,QAAQ,4BAA4B,EAAE;AAGrE,QAAM,cAAc,OAAO,KAAK,aAAa,QAAQ;AAGrD,QAAM,WAAW,KAAK,KAAK,UAAU,GAAG,QAAQ,MAAM;AAGtD,KAAG,cAAc,UAAU,WAAW;AAEtC,SAAO;AACT;AAEA,eAAsB,iBACpB,UACA,UACiB;AACjB,QAAM,WAAW,KAAK,KAAK,WAAW,UAAU,MAAM;AACtD,cAAY,IAAI,sCAAsC,QAAQ;AAC9D,MAAI,CAAC,GAAG,WAAW,QAAQ,GAAG;AAC5B,OAAG,UAAU,UAAU,EAAE,WAAW,KAAK,CAAC;AAAA,EAC5C;AAGA,QAAM,WAAW,MAAM,MAAM,QAAQ;AACrC,MAAI,CAAC,SAAS,IAAI;AAChB,UAAM,IAAI,MAAM,0BAA0B,SAAS,UAAU,EAAE;AAAA,EACjE;AAEA,QAAM,cAAc,MAAM,SAAS,YAAY;AAC/C,QAAM,cAAc,OAAO,KAAK,WAAW;AAG3C,QAAM,WAAW,KAAK,KAAK,UAAU,GAAG,QAAQ,MAAM;AAGtD,KAAG,cAAc,UAAU,WAAW;AAEtC,SAAO;AACT;AAEA,YAAY,IAAI,sCAAsC;AAEtD,IAAM,sBAA8B;AAAA,EAClC,MAAM;AAAA,EACN,SAAS;AAAA,IACP;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AAAA,EACA,aAAa;AAAA,EACb,wBAAwB;AAAA,EACxB,UAAU,OAAO,SAAwB,YAAoB;AAC3D,UAAM,eAAe,QAAQ,WAAW,gBAAgB;AACxD,YAAQ,IAAI,qCAA8B,CAAC,CAAC,YAAY;AAIxD,WAAO,CAAC,CAAC;AAAA,EACX;AAAA,EACA,SAAS,OACP,SACA,SACA,OACA,SACA,aACG;AACH,YAAQ,IAAI,8CAAuC;AAGnD,aAAS;AAAA,MACP,MAAM;AAAA,IACR,CAAC;AAED,UAAM,cAAc,MAAM,aAAa;AAAA,MACrC;AAAA,MACA,SAAS,QAAQ,QAAQ;AAAA,MACzB,YAAY,WAAW;AAAA,MACvB,oBAAoB;AAAA,IACtB,CAAC;AAED,YAAQ,IAAI,+BAAwB,WAAW;AAG/C,aAAS;AAAA,MACP,MAAM,+BAA+B,WAAW;AAAA,IAClD,CAAC;AAED,UAAM,SAAS,MAAM;AAAA,MACnB;AAAA,QACE,QAAQ;AAAA,QACR,SAAS;AAAA,QACT,OAAO;AAAA,QACP,QAAQ;AAAA,MACV;AAAA,MACA;AAAA,IACF;AAEA,YAAQ,IAAI,4CAAgC,MAAM;AAElD,QAAI,OAAO,WAAW,OAAO,QAAQ,OAAO,KAAK,SAAS,GAAG;AAC3D,eAAS;AAAA,QACP,MAAM;AAAA,QACN,aAAa;AAAA,UACX;AAAA,YACE,IAAI,OAAO,WAAW;AAAA,YACtB,KAAK,OAAO,KAAK,CAAC;AAAA,YAClB,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,aAAa;AAAA,YACb,MAAM;AAAA,YACN,aAAa;AAAA,UACf;AAAA,QACF;AAAA,MACF,CAAC;AACD,aAAO;AAAA,IACT;AAEA,aAAS;AAAA,MACP,MAAM;AAAA,IACR,CAAC;AACD,WAAO;AAAA,EACT;AAAA,EACA,UAAU;AAAA;AAAA,IAGR;AAAA,MACE;AAAA,QACE,MAAM;AAAA,QACN,SAAS,EAAE,MAAM,6BAA6B;AAAA,MAChD;AAAA,MACA;AAAA,QACE,MAAM;AAAA,QACN,SAAS;AAAA,UACP,MAAM;AAAA,UACN,QAAQ;AAAA,QACV;AAAA,MACF;AAAA,IACF;AAAA,IACA;AAAA,MACE;AAAA,QACE,MAAM;AAAA,QACN,SAAS,EAAE,MAAM,6BAA6B;AAAA,MAChD;AAAA,MACA;AAAA,QACE,MAAM;AAAA,QACN,SAAS;AAAA,UACP,MAAM;AAAA,UACN,QAAQ;AAAA,QACV;AAAA,MACF;AAAA,IACF;AAAA,IACA;AAAA,MACE;AAAA,QACE,MAAM;AAAA,QACN,SAAS,EAAE,MAAM,sCAAsC;AAAA,MACzD;AAAA,MACA;AAAA,QACE,MAAM;AAAA,QACN,SAAS;AAAA,UACP,MAAM;AAAA,UACN,QAAQ;AAAA,QACV;AAAA,MACF;AAAA,IACF;AAAA,IACA;AAAA,MACE;AAAA,QACE,MAAM;AAAA,QACN,SAAS,EAAE,MAAM,oCAAoC;AAAA,MACvD;AAAA,MACA;AAAA,QACE,MAAM;AAAA,QACN,SAAS;AAAA,UACP,MAAM;AAAA,UACN,QAAQ;AAAA,QACV;AAAA,MACF;AAAA,IACF;AAAA,IACA;AAAA,MACE;AAAA,QACE,MAAM;AAAA,QACN,SAAS,EAAE,MAAM,qCAAqC;AAAA,MACxD;AAAA,MACA;AAAA,QACE,MAAM;AAAA,QACN,SAAS;AAAA,UACP,MAAM;AAAA,UACN,QAAQ;AAAA,QACV;AAAA,MACF;AAAA,IACF;AAAA,EACF;AACF;AAEO,IAAM,4BAAoC;AAAA,EAC/C,MAAM;AAAA,EACN,aAAa;AAAA,EACb,SAAS,CAAC,mBAAmB;AAAA,EAC7B,YAAY,CAAC;AAAA,EACb,WAAW,CAAC;AACd;AAEA,YAAY,IAAI,wCAAwC;AACxD,IAAO,gBAAQ;","names":[]}